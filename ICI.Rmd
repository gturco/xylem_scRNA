
##ICI scores


# Load Functions for ICI score from Kens paper 

```{r}
#####################################################################################
#
# Identity
#
# Calculate Index of Cell Identity (ICI)
#
#  Idan Efroni (ie10@nyu.edu)
#  Dec  14th, 2014
#####################################################################################

# Number of permuations used to calculate significance
RAND_ITER=1000

# The minimal Spec score that can be used as a marker
MIN_USEFUL_SPEC= 0.15

#  Arguments
#    cell - vector of gene expression values
#    ci_for_mark - spec scores for the markers
#    markers - list of markers from getMarkerList

getIdentityScore <- function(cell, ci_for_mark, markers){
	mean(cell[markers]* ci_for_mark) * ((sum(cell[markers]>0))/length(markers))
}
#####################################################################################
#
#  getIdentity
#
#  returns ICIs for a data matrix
#
#  Arguments
#    data - gene expression matrix
#    ci - spec data structure
#    markers - list of markers from getMarkerList
#    returnSig - should significance be calculated
#    universe - what subset of genes should be used for randomizations

getIdentity <- function(data, ci, markers, returnSig=FALSE, universe=c()) {
	
	hs_scoremat <- matrix(nrow=ncol(data), ncol=length(markers))

	colnames(hs_scoremat) <- names(markers)
	rownames(hs_scoremat) <- colnames(data)
	calls <- hs_scoremat
	sig <- calls
	all_markers = unlist(markers)

	for(cell in 1:nrow(hs_scoremat)) {
		markers_cell = data[, cell]
		head(print(markers_cell))
		for(mark in 1:length(markers)) {
			print(mark)
		  hs_scoremat[cell, mark] = getIdentityScore(data[,cell], ci[[1]][markers[[mark]],mark], markers[[mark]])
			calls[cell, mark] = sum(data[markers[[mark]],cell]>0)
			if(returnSig) {
				sig[cell,mark] <- 1-which(order(c(hs_scoremat[cell,mark], getRandomBackground(markers_cell, ci[[1]][markers[[mark]],mark], universe, length(markers[[mark]]))))==1)/(RAND_ITER+1)
			}
		}
	}

	hs_scoremat_norm <- hs_scoremat
	for(i in 1:nrow(hs_scoremat_norm)) { hs_scoremat_norm[i,] = hs_scoremat_norm[i,]/sum(hs_scoremat_norm[i,]) }
	hs_scoremat_norm[is.nan(hs_scoremat_norm)]=0
	if(returnSig) {
		list(hs_scoremat_norm, hs_scoremat, calls, sig, matrix(nrow=nrow(sig), ncol=ncol(sig), p.adjust(sig, "BH")))
	} else {
		list(hs_scoremat_norm, hs_scoremat)
	}
}
```

```{r}
gene_expression_matrix <- as.data.frame(as.matrix(merged@data))
ci <- read.csv("spec_scores.csv", row.names="Locus")
markers <- read.csv("markers.csv", row.names="Locus")
universe = rownames(gene_expression_matrix)

getIdentity <- function(data, ci){
  d <- merge(data, ci,by.x = 0, by.y = 0)
  ### make data matrix of cells X tissue_types 
  hs_scoremat <- matrix(nrow=ncol(data), ncol=ncol(ci))
  colnames(hs_scoremat) <- colnames(ci)
	rownames(hs_scoremat) <- colnames(data)
  #for each cell
  for(n_cell in 1:ncol(data)){
    ### for each marker
    for(n_marker in 1:ncol(ci)){
      number_of_tissue_markers <- sum(ci[,n_marker] > 0)
      number_of_expressed_markers <- sum(d[,n_cell+1] > 0)
      cell_ici = sum(d[,n_cell+1] * d[,n_marker + ncol(data)])/number_of_tissue_markers * (number_of_expressed_markers/number_of_tissue_markers) 
      print(n_cell)
      print(n_marker)
      hs_scoremat[n_cell, n_marker] = cell_ici
  }
    }
  return(hs_scoremat)
}

# can use mean if mean kepts all the scores

i <- getIdentity(gene_expression_matrix,ci)
x <- melt(i)
colnames(x) <- c("cell","tissue","value")
library(reshape)
x <- subset(x, tissue != "Trichoblast")
ggplot(x, aes(tissue, cell)) + geom_tile(aes(fill = value)) + theme(axis.text=element_text(size=10, angle = 60), axis.text.y = element_blank())
```

## There is a correlation between VND7 expression and protoxylem ICI score 

```{r}                                                    
ci <- read.csv("Protoxylem.csv")

getOneIdentity <- function(data, ci){
  d <- merge(data, ci,by.x = 0, by.y = "Locus")
  ici_scores <- vector()
  for(n_cell in 4:ncol(d) -2){
  cell_ici = sum(d[,n_cell] * d$Protoxylem)/nrow(ci) * (nrow(d)/nrow(ci)) 
  ici_scores[n_cell-1] <- cell_ici
  }
  return(ici_scores)
}

proto <- getOneIdentity(gene_expression_matrix,ci)


y <- data.frame(as.numeric(as.matrix(merged@data["AT1G71930",])),proto)
colnames(y) <- c("vnd7","xylem")
cor(y$vnd7,y$xylem)
ggplot(data = y, aes(vnd7,xylem)) + geom_point()

```
### Get Diff expression of VND7 and ICI scores between tissue types
```{r}
ggplot(i) + geom_heatmap()

```
