
##ICI scores


# Load Functions for ICI score from Kens paper 

```{r}
#####################################################################################
#
# Identity
#
# Calculate Index of Cell Identity (ICI)
#
#  Idan Efroni (ie10@nyu.edu)
#  Dec  14th, 2014
#####################################################################################

# Number of permuations used to calculate significance
RAND_ITER=1000

# The minimal Spec score that can be used as a marker
MIN_USEFUL_SPEC= 0.15

#  Arguments
#    cell - vector of gene expression values
#    ci_for_mark - spec scores for the markers
#    markers - list of markers from getMarkerList

getIdentityScore <- function(cell, ci_for_mark, markers){
	mean(cell[markers]* ci_for_mark) * ((sum(cell[markers]>0))/length(markers))
}
#####################################################################################
#
#  getIdentity
#
#  returns ICIs for a data matrix
#
#  Arguments
#    data - gene expression matrix
#    ci - spec data structure
#    markers - list of markers from getMarkerList
#    returnSig - should significance be calculated
#    universe - what subset of genes should be used for randomizations

getIdentity <- function(data, ci, markers, returnSig=FALSE, universe=c()) {
	
	hs_scoremat <- matrix(nrow=ncol(data), ncol=length(markers))

	colnames(hs_scoremat) <- names(markers)
	rownames(hs_scoremat) <- colnames(data)
	calls <- hs_scoremat
	sig <- calls
	all_markers = unlist(markers)

	for(cell in 1:nrow(hs_scoremat)) {
		markers_cell = data[, cell]
		head(print(markers_cell))
		for(mark in 1:length(markers)) {
			print(mark)
		  hs_scoremat[cell, mark] = getIdentityScore(data[,cell], ci[[1]][markers[[mark]],mark], markers[[mark]])
			calls[cell, mark] = sum(data[markers[[mark]],cell]>0)
			if(returnSig) {
				sig[cell,mark] <- 1-which(order(c(hs_scoremat[cell,mark], getRandomBackground(markers_cell, ci[[1]][markers[[mark]],mark], universe, length(markers[[mark]]))))==1)/(RAND_ITER+1)
			}
		}
	}

	hs_scoremat_norm <- hs_scoremat
	for(i in 1:nrow(hs_scoremat_norm)) { hs_scoremat_norm[i,] = hs_scoremat_norm[i,]/sum(hs_scoremat_norm[i,]) }
	hs_scoremat_norm[is.nan(hs_scoremat_norm)]=0
	if(returnSig) {
		list(hs_scoremat_norm, hs_scoremat, calls, sig, matrix(nrow=nrow(sig), ncol=ncol(sig), p.adjust(sig, "BH")))
	} else {
		list(hs_scoremat_norm, hs_scoremat)
	}
}
```

# my function re-writen for my data
```{r}
getIdentity <- function(data, ci){
  d <- merge(data, ci,by.x = 0, by.y = 0)
  ### make data matrix of cells X tissue_types 
  hs_scoremat <- matrix(nrow=ncol(data), ncol=ncol(ci))
  colnames(hs_scoremat) <- colnames(ci)
	rownames(hs_scoremat) <- colnames(data)
  #for each cell
  for(n_cell in 1:ncol(data)){
    ### for each marker
    for(n_marker in 1:ncol(ci)){
      number_of_tissue_markers <- sum(ci[,n_marker] > 0)
      number_of_expressed_markers <- sum(d[,n_cell+1] > 0)
      cell_ici = sum(d[,n_cell+1] * d[,(n_marker + ncol(data))+1])/number_of_tissue_markers       * (number_of_expressed_markers/number_of_tissue_markers) 
      print(n_cell)
      print(n_marker)
      hs_scoremat[n_cell, n_marker] = cell_ici
  }
    }
  return(hs_scoremat)
}

```
### ICI scores do not match between samples and larger experiment

```{r}
gene_expression_matrix <- as.data.frame(as.matrix(merged@data))
ci <- read.csv("spec_scores.csv", row.names="Locus")
markers <- read.csv("markers.csv",row.names="Locus")
universe = rownames(gene_expression_matrix)

# can use mean if mean kepts all the scores

i <- getIdentity(gene_expression_matrix,ci)
summary(i)

library(reshape)
x <- melt(i)
colnames(x) <- c("cell","tissue","value")
ggplot(x, aes(tissue, cell)) + geom_tile(aes(fill = value,vjust=TRUE)) + theme(axis.text=element_text(size=10, angle = 60), axis.text.y = element_blank())
```

## There is a correlation between VND7 expression and protoxylem ICI score 

```{r}                                                    
pci <- read.csv("Protoxylem.csv", row.names = "Locus")
l <- data.frame(ci[,8])
rownames(l) <- rownames(ci)
colnames(l) <- c("Protoxylem")

getOneIdentity <- function(data, spec){
  d <- merge(data, spec,by.x = 0, by.y = 0)
  ici_scores <- vector()
  for(n_cell in 1:ncol(data)){
      number_of_tissue_markers <- sum(spec$Protoxylem > 0)
      number_of_expressed_markers <- sum(d[,n_cell+1] > 0)
      print(n_cell)
      cell_ici = sum(d[,n_cell+1] * d$Protoxylem)/number_of_tissue_markers * (number_of_expressed_markers/number_of_tissue_markers) 
      ici_scores[n_cell] <- cell_ici
  }
  return(ici_scores)
}

proto <- getOneIdentity(gene_expression_matrix,l)
summary(proto)

y <- data.frame(as.numeric(as.matrix(merged@data["AT1G71930",])),proto)
colnames(y) <- c("vnd7","xylem")
cor(y$vnd7,y$xylem)
ggplot(data = y, aes(vnd7,xylem)) + geom_point()

```
### ICI for clusters
```{r}
ci <- read.csv("spec_scores.csv", row.names="Locus")
cluster.markers <- read.table("all_markers_merged.txt", header = TRUE)
cluster_0 <- subset(cluster.markers, cluster == 0)
cluster_1 <- subset(cluster.markers, cluster == 1)
cluster_2 <- subset(cluster.markers, cluster == 2)
cluster_3 <- subset(cluster.markers, cluster == 3)
cluster_4 <- subset(cluster.markers, cluster == 4)
cluster_5 <- subset(cluster.markers, cluster == 5)
cluster_6 <- subset(cluster.markers, cluster == 6)
cluster_7 <- subset(cluster.markers, cluster == 7)
cluster_8 <- subset(cluster.markers, cluster == 8)

getClusterIdentity <- function(cluster, ci){
  d <- merge(cluster, ci,by.x = "gene", by.y = 0)
  for(n_marker in 1:ncol(ci)){
      number_of_tissue_markers <- nrow(d)
      number_of_expressed_markers <- length(cluster)
      cell_ici = sum(d$avg_diff * d[,n_marker + ncol(cluster)])/number_of_tissue_markers * number_of_tissue_markers/number_of_expressed_markers
    print(colnames(ci)[n_marker])
    print(cell_ici)
    }
}

getClusterIdentity(cluster_0,ci)
getClusterIdentity(cluster_1,ci)
getClusterIdentity(cluster_2,ci)
getClusterIdentity(cluster_3,ci)
getClusterIdentity(cluster_4,ci)
getClusterIdentity(cluster_5,ci)
getClusterIdentity(cluster_6,ci)
getClusterIdentity(cluster_7,ci)
getClusterIdentity(cluster_8,ci)

```
